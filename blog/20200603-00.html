<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qt动态翻译 | 我的博客</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="nav">
        <a href="index.html" class="nav-home">返回主页</a>
    </div>
    <div class="container post-page">
        <main>
            <article class="post">
                <h1>Qt动态翻译</h1>
                <div class="post-meta">
                    2020-06-03 · 
                    Qt
                </div>
                <div class="post-content">
                    <h4>setting.h</h4>
<div class="codehilite"><div class_="code-lang">C++</div><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#pragma once</span>

<span class="cp">#pragma execution_character_set("utf-8") </span><span class="c1">// 编译时把程序里的字符串使用 UTF-8 进行处理</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QTranslator&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QWidget&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QMutex&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"ui_setting.h"</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"vanxkr/config/config.h"</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Setting</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">QWidget</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Q_OBJECT</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">Setting</span><span class="w"> </span><span class="o">*</span><span class="n">Setting</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Q_NULLPTR</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">QMutexLocker</span><span class="w"> </span><span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Q_NULLPTR</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Setting</span><span class="w"> </span><span class="o">*</span><span class="n">instance_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Setting</span><span class="p">();</span>
<span class="w">                </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance_</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 常量</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">QMap</span><span class="o">&lt;</span><span class="n">QString</span><span class="p">,</span><span class="w"> </span><span class="n">QString</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cLanguageMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span><span class="s">"中文"</span><span class="p">,</span><span class="w"> </span><span class="s">"zh"</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="s">"English"</span><span class="p">,</span><span class="w"> </span><span class="s">"en"</span><span class="p">},</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="n">QTranslator</span><span class="o">&amp;</span><span class="w"> </span><span class="nf">getTranslator</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">translator</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">public</span><span class="w"> </span><span class="n">slots</span><span class="o">:</span>
<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">setLanguage</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">QString</span><span class="w"> </span><span class="o">&amp;</span><span class="n">language</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ui</span><span class="p">.</span><span class="n">comboBox_language</span><span class="o">-&gt;</span><span class="n">blockSignals</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="w">        </span><span class="n">ui</span><span class="p">.</span><span class="n">comboBox_language</span><span class="o">-&gt;</span><span class="n">setCurrentText</span><span class="p">(</span><span class="n">language</span><span class="p">);</span>
<span class="w">        </span><span class="n">on_comboBox_language_currentTextChanged</span><span class="p">(</span><span class="n">language</span><span class="p">);</span>
<span class="w">        </span><span class="n">ui</span><span class="p">.</span><span class="n">comboBox_language</span><span class="o">-&gt;</span><span class="n">blockSignals</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">changeEvent</span><span class="p">(</span><span class="n">QEvent</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">Setting</span><span class="p">(</span><span class="n">QWidget</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Q_NULLPTR</span><span class="p">);</span>
<span class="w">    </span><span class="o">~</span><span class="n">Setting</span><span class="p">();</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">Setting</span><span class="w"> </span><span class="o">*</span><span class="n">instance</span><span class="p">;</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">QMutex</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">GC</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// GC 机制 自动回收</span>
<span class="w">    </span><span class="k">public</span><span class="o">:</span>
<span class="w">        </span><span class="o">~</span><span class="n">GC</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 可以在这里销毁所有的资源</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Q_NULLPTR</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">deleteLater</span><span class="p">();</span>
<span class="w">                </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Q_NULLPTR</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="n">GC</span><span class="w"> </span><span class="n">gc</span><span class="p">;</span><span class="w">  </span><span class="c1">// 用于释放单例</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// 常量</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">QString</span><span class="w"> </span><span class="n">cQmPrefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">":/qm/"</span><span class="p">;</span>

<span class="w">    </span><span class="n">Ui</span><span class="o">::</span><span class="n">Setting</span><span class="w"> </span><span class="n">ui</span><span class="p">;</span>

<span class="w">    </span><span class="n">Config</span><span class="o">*</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">getInstance</span><span class="p">();</span>
<span class="w">    </span><span class="n">QString</span><span class="w"> </span><span class="n">language</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Q_NULLPTR</span><span class="p">;</span>
<span class="w">    </span><span class="n">QTranslator</span><span class="w"> </span><span class="n">translator</span><span class="p">;</span>

<span class="nl">singnals</span><span class="p">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">languageChanged</span><span class="p">();</span><span class="w"> </span><span class="c1">// 直接发送语言切换 其他类不需要再写 changeEvent</span>

<span class="k">private</span><span class="w"> </span><span class="n">slots</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">initWidget</span><span class="p">();</span><span class="w">  </span><span class="c1">// </span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">retranslateUi</span><span class="p">();</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">setLanguagePrivate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">QString</span><span class="w"> </span><span class="o">&amp;</span><span class="n">language</span><span class="p">);</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">on_comboBox_language_currentTextChanged</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">QString</span><span class="w"> </span><span class="o">&amp;</span><span class="n">text</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></td></tr></table></div>
<h4>setting.cpp</h4>
<div class="codehilite"><div class_="code-lang">C++</div><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#pragma execution_character_set("utf-8") </span><span class="c1">// 编译时把程序里的字符串使用 UTF-8 进行处理</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QDebug&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"setting.h"</span>

<span class="n">Setting</span><span class="w"> </span><span class="o">*</span><span class="n">Setting</span><span class="o">::</span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Q_NULLPTR</span><span class="p">;</span>
<span class="n">QMutex</span><span class="w"> </span><span class="n">Setting</span><span class="o">::</span><span class="n">mutex</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">Setting::changeEvent</span><span class="p">(</span><span class="n">QEvent</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">QEvent</span><span class="o">::</span><span class="n">LanguageChange</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">emit</span><span class="w"> </span><span class="n">languageChanged</span><span class="p">();</span><span class="w"> </span><span class="c1">// </span>
<span class="w">        </span><span class="n">retranslateUi</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">QWidget</span><span class="o">::</span><span class="n">changeEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">Setting</span><span class="o">::</span><span class="n">Setting</span><span class="p">(</span><span class="n">QWidget</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">QWidget</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">setWindowModality</span><span class="p">(</span><span class="n">Qt</span><span class="o">::</span><span class="n">ApplicationModal</span><span class="p">);</span><span class="w">    </span><span class="c1">// 打开子窗口 锁定父窗口</span>
<span class="w">    </span><span class="n">setWindowFlags</span><span class="p">(</span><span class="n">Qt</span><span class="o">::</span><span class="n">WindowCloseButtonHint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Qt</span><span class="o">::</span><span class="n">MSWindowsFixedSizeDialogHint</span><span class="p">);</span><span class="w">   </span><span class="c1">// 设置窗口只保留关闭按钮 且 固定大小</span>

<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">setupUi</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

<span class="w">    </span><span class="n">initWidget</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">Setting</span><span class="o">::~</span><span class="n">Setting</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">Setting</span><span class="o">::</span><span class="n">initWidget</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="c1">// </span>
<span class="w">    </span><span class="n">QStringList</span><span class="w"> </span><span class="n">languageList</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cLanguageMap</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cLanguageMap</span><span class="p">.</span><span class="n">cend</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 只读</span>
<span class="w">        </span><span class="n">languageList</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">key</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">comboBox_language</span><span class="o">-&gt;</span><span class="n">blockSignals</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">comboBox_language</span><span class="o">-&gt;</span><span class="n">addItems</span><span class="p">(</span><span class="n">languageList</span><span class="p">);</span>
<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">comboBox_language</span><span class="o">-&gt;</span><span class="n">blockSignals</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">Setting</span><span class="o">::</span><span class="n">retranslateUi</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">retranslateUi</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">Setting</span><span class="o">::</span><span class="n">setLanguagePrivate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">QString</span><span class="w"> </span><span class="o">&amp;</span><span class="n">language</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">language</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">language</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">   </span><span class="c1">// </span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">language</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">language</span><span class="p">;</span>
<span class="w">        </span><span class="n">QString</span><span class="w"> </span><span class="n">qm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cQmPrefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cLanguageMap</span><span class="p">[</span><span class="n">language</span><span class="p">];</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">translator</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">qm</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 成功了才写入</span>
<span class="w">            </span><span class="n">config</span><span class="o">-&gt;</span><span class="n">iniWrite</span><span class="p">(</span><span class="s">"Setting/language"</span><span class="p">,</span><span class="w"> </span><span class="n">language</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">Setting</span><span class="o">::</span><span class="n">on_comboBox_language_currentTextChanged</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">QString</span><span class="w"> </span><span class="o">&amp;</span><span class="n">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setLanguagePrivate</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4>translate.h</h4>
<div class="codehilite"><div class_="code-lang">C++</div><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#pragma once</span>

<span class="cp">#pragma execution_character_set("utf-8") </span><span class="c1">// 编译时把程序里的字符串使用 UTF-8 进行处理</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QtWidgets/QMainWindow&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"ui_translate.h"</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"setting.h"</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Translate</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">QMainWindow</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Q_OBJECT</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">Translate</span><span class="w"> </span><span class="o">*</span><span class="n">Translate</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Q_NULLPTR</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">QMutexLocker</span><span class="w"> </span><span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Q_NULLPTR</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Translate</span><span class="w"> </span><span class="o">*</span><span class="n">instance_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Translate</span><span class="p">();</span>
<span class="w">                </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance_</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">changeEvent</span><span class="p">(</span><span class="n">QEvent</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">Translate</span><span class="p">(</span><span class="n">QWidget</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="o">~</span><span class="n">Translate</span><span class="p">();</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">Translate</span><span class="w"> </span><span class="o">*</span><span class="n">instance</span><span class="p">;</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">QMutex</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">GC</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// GC 机制 自动回收</span>
<span class="w">    </span><span class="k">public</span><span class="o">:</span>
<span class="w">        </span><span class="o">~</span><span class="n">GC</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 可以在这里销毁所有的资源</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Q_NULLPTR</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">delete</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span>
<span class="w">                </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Q_NULLPTR</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="n">GC</span><span class="w"> </span><span class="n">gc</span><span class="p">;</span><span class="w">  </span><span class="c1">// 用于释放单例</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">Ui</span><span class="o">::</span><span class="n">Translate</span><span class="w"> </span><span class="n">ui</span><span class="p">;</span>

<span class="w">    </span><span class="n">Setting</span><span class="o">*</span><span class="w"> </span><span class="n">setting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Setting</span><span class="o">::</span><span class="n">getInstance</span><span class="p">();</span>

<span class="w">    </span><span class="n">QAction</span><span class="o">*</span><span class="w"> </span><span class="n">actionSetting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">QAction</span><span class="p">();</span>

<span class="k">private</span><span class="w"> </span><span class="n">slots</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">retranslateUi</span><span class="p">();</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">initWidget</span><span class="p">();</span><span class="w">  </span><span class="c1">// </span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">initConnect</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div></td></tr></table></div>
<h4>translate.cpp</h4>
<div class="codehilite"><div class_="code-lang">C++</div><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#pragma execution_character_set("utf-8") </span><span class="c1">// 编译时把程序里的字符串使用 UTF-8 进行处理</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QDebug&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"translate.h"</span>

<span class="n">Translate</span><span class="w"> </span><span class="o">*</span><span class="n">Translate</span><span class="o">::</span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Q_NULLPTR</span><span class="p">;</span>
<span class="n">QMutex</span><span class="w"> </span><span class="n">Translate</span><span class="o">::</span><span class="n">mutex</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">Translate::changeEvent</span><span class="p">(</span><span class="n">QEvent</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">QEvent</span><span class="o">::</span><span class="n">LanguageChange</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">retranslateUi</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">QMainWindow</span><span class="o">::</span><span class="n">changeEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">Translate</span><span class="o">::</span><span class="n">Translate</span><span class="p">(</span><span class="n">QWidget</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">QMainWindow</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">setupUi</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

<span class="w">    </span><span class="n">initWidget</span><span class="p">();</span>
<span class="w">    </span><span class="n">initConnect</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">Translate</span><span class="o">::~</span><span class="n">Translate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">actionSetting</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">Translate</span><span class="o">::</span><span class="n">retranslateUi</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">retranslateUi</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="n">actionSetting</span><span class="o">-&gt;</span><span class="n">setText</span><span class="p">(</span><span class="n">tr</span><span class="p">(</span><span class="s">"设置(Setting)"</span><span class="p">));</span>
<span class="p">}</span>


<span class="kt">void</span><span class="w"> </span><span class="n">Translate</span><span class="o">::</span><span class="n">initWidget</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// </span>
<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">menuBar</span><span class="o">-&gt;</span><span class="n">addAction</span><span class="p">(</span><span class="n">actionSetting</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">Translate</span><span class="o">::</span><span class="n">initConnect</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">connect</span><span class="p">(</span><span class="n">actionSetting</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">QAction</span><span class="o">::</span><span class="n">triggered</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">setting</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">();</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4>main.cpp</h4>
<div class="codehilite"><div class_="code-lang">C++</div><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#pragma execution_character_set("utf-8") </span><span class="c1">// 编译时把程序里的字符串使用 UTF-8 进行处理</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QtWidgets/QApplication&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QTextCodec&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QDebug&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QDir&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"translate.h"</span>

<span class="n">Translate</span><span class="o">::</span><span class="n">GC</span><span class="w"> </span><span class="n">Translate</span><span class="o">::</span><span class="n">GC</span><span class="o">::</span><span class="n">gc</span><span class="p">;</span><span class="w">    </span><span class="c1">// 单例</span>
<span class="n">Setting</span><span class="o">::</span><span class="n">GC</span><span class="w"> </span><span class="n">Setting</span><span class="o">::</span><span class="n">GC</span><span class="o">::</span><span class="n">gc</span><span class="p">;</span><span class="w">    </span><span class="c1">// 单例</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">QApplication</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>

<span class="w">    </span><span class="n">QTextCodec</span><span class="o">::</span><span class="n">setCodecForLocale</span><span class="p">(</span><span class="n">QTextCodec</span><span class="o">::</span><span class="n">codecForName</span><span class="p">(</span><span class="s">"UTF-8"</span><span class="p">));</span><span class="w">   </span><span class="c1">// 使用 UTF-8 的运行时环境</span>
<span class="w">    </span><span class="n">QDir</span><span class="o">::</span><span class="n">setCurrent</span><span class="p">(</span><span class="n">QCoreApplication</span><span class="o">::</span><span class="n">applicationDirPath</span><span class="p">());</span><span class="w">   </span><span class="c1">// 设置当前目录为 app所在目录</span>

<span class="w">    </span><span class="n">Setting</span><span class="o">*</span><span class="w"> </span><span class="n">setting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Setting</span><span class="o">::</span><span class="n">getInstance</span><span class="p">();</span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">installTranslator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Setting</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getTranslator</span><span class="p">());</span>
<span class="w">    </span><span class="n">setting</span><span class="o">-&gt;</span><span class="n">setLanguage</span><span class="p">(</span>
<span class="w">        </span><span class="n">Config</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">iniRead</span><span class="p">(</span>
<span class="w">            </span><span class="s">"Setting/language"</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">setting</span><span class="o">-&gt;</span><span class="n">cLanguageMap</span><span class="p">.</span><span class="n">cbegin</span><span class="p">().</span><span class="n">key</span><span class="p">()</span>
<span class="w">        </span><span class="p">).</span><span class="n">toString</span><span class="p">()</span>
<span class="w">    </span><span class="p">);</span><span class="w">  </span><span class="c1">// 加载配置文件语言</span>

<span class="w">    </span><span class="n">Translate</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4>(╯#-_-)╯~~PS</h4>
<p>动态翻译的关键在于: </p>
<ol>
<li>对用户可见的文本信息全部使用<code>tr()</code>进行封装 (<strong>中文是可以的</strong> 此处反驳一下那些说不能用<code>tr()</code>包中文的人 <strong>(#‵′)凸</strong>)</li>
<li>使用<code>lupdate</code>导出项目翻译文件:<code>.ts</code>    (要多少种语言就导出多少种 <strong>项目使用的原始语言也要导出</strong> 只是在翻译时不需要进行任何翻译直接发布即可)</li>
<li>使用<code>Qt Linguist</code>对<code>.ts</code>文件进行翻译并发布成为<code>.qm</code></li>
<li>项目中实现语言切换功能 顺序很重要: <ol>
<li>先<code>QApplication</code>安装<code>QTranslator</code></li>
<li>再使用<code>QTranslator::load</code> 翻译文件<code>.qm</code> (<strong>一定要记得要是上面安装的那个<code>QTranslator</code></strong>)</li>
<li>以上操作成功即会给所有界面发送<code>changeEvent(QEvent::LanguageChange)</code>事件</li>
<li>在每一个对用户可见的文本信息显示的类里面实现并在以上的事件响应<code>retranslateUi()</code>操作   (<strong>ui文件已帮你实现retranslateUi(Ui::Class)翻译Ui自带的翻译内容 记得调用哦 (→_→)</strong>)</li>
</ol>
</li>
</ol>
<hr/>
<p><strong>以上&lt;(￣︶￣)&gt;</strong> </p>
<p>有更好的方案欢迎骚扰 []~(￣▽￣)~* <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=1328559904&amp;site=qq&amp;menu=yes">vanxkr@qq.com(链接是打开QQ小窗)</a></p>
<p>ฅ(• - •)ฅ 喜欢就留个赞啵~ ฅʕ•̫͡•</p>
<h4>补充 - 2021-3-2 17:29:37</h4>
<p>在每一个界面写一次 <code>void changeEvent(QEvent *event);</code> 相对麻烦点</p>
<p>这里有一个方案</p>
<p>我是这么做的</p>
<ol>
<li>在 <code>setting.cpp</code> 的 <code>void changeEvent(QEvent *event);</code> 里面 <code>emit languageChanged();</code> 信号</li>
<li>在其他界面 <code>connect(setting, &amp;Setting::languageChanged, this, &amp;Class::retranslateUi);</code> 即可</li>
</ol>
                </div>
            </article>
        </main>
    </div>

    <footer>
        <p>© 2025 我的博客 · 基于Markdown生成</p>
    </footer>
</body>
</html>